<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.79.0" />

  <title> A Statsd HTTP Handler Wrapper |  Time Traveling Gopher</title>
  <meta name="description" content="Time Traveling Gopher">
  <link rel="stylesheet" href="https://adnaan.badr.in/css/simpleness.css">
  <link rel="canonical" href="https://adnaan.badr.in/blog/2017/07/20/a-statsd-http-handler-wrapper/">
  <link rel="alternate" type="application/rss+xml" href="" title="Time Traveling Gopher">
  
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
</head>

<body>
  <header class="menus">
  
  <a href="https://adnaan.badr.in/">Time Traveling Gopher</a>
  

  <nav >
    
  </nav>

  <nav class="fontawesome">
    
    
  </nav>
  
  
  <div class="hidden description">Time Traveling Gopher</div>
  
</header>

<article class="article">
  <header>
    <h1 style="text-align: center;" >A Statsd HTTP Handler Wrapper</h1>

    <div class="post-meta">
    
      <time datetime="2017-07-20T16:46:28Z">July 20, 2017</time> &nbsp; 
    

     &nbsp;

    
    
    

    

    
    </div>
  </header>

   

  <div class="text">
    <p>Statsd is a simple and effective tool to trace app metrics: http request latency, throughput, runtime metrics etc. Using the package <a href="https://godoc.org/gopkg.in/alexcesaro/statsd.v2">alexcesaro/statsd.v2</a>, tracking response time of a request is a one liner:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>(){
  <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chi</span>.<span style="color:#a6e22e">NewRouter</span>()
  <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;/&#34;</span>,<span style="color:#a6e22e">handleHome</span>)
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">handleHome</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">NewTiming</span>().<span style="color:#a6e22e">Send</span>(<span style="color:#e6db74">&#34;homepage.response_time&#34;</span>)
  <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Increment</span>(<span style="color:#e6db74">&#34;foo.counter&#34;</span>)
  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>)
  <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>)
  <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
}
</code></pre></div><p>But this gets cumbersome if you have more than a couple of handlers and would want to track other metrics too.</p>
<p>A http handler wrapper is an idiomatic way to overcome code strewn with statsd metric sends. <a href="https://github.com/adnaan/statsdwrap">statsdwrap</a> package is a simple implementation of this approach. It&rsquo;s a tiny package for the <a href="https://github.com/go-chi/chi">chi</a> router.</p>
<p>Usage:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">chi</span>.<span style="color:#a6e22e">NewRouter</span>()
<span style="color:#a6e22e">statsdClient</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">New</span>(
  <span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Prefix</span>(<span style="color:#e6db74">&#34;myapp&#34;</span>),
  <span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Address</span>(<span style="color:#e6db74">&#34;localhost:8125&#34;</span>),
)
<span style="color:#a6e22e">wrap</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">statsdwrap</span>.<span style="color:#a6e22e">NewChi</span>(<span style="color:#e6db74">&#34;user_service&#34;</span>, <span style="color:#a6e22e">statsdClient</span>)
<span style="color:#a6e22e">handleHome</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
  <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Millisecond</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>)
  <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">WriteHeader</span>(<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusOK</span>)
  <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>([]byte(<span style="color:#e6db74">&#34;OK&#34;</span>))
}
<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#a6e22e">wrap</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#e6db74">&#34;home&#34;</span>, <span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#a6e22e">handleHome</span>))
</code></pre></div><p>By default the wrapper sends the following metrics for http: <code>response_time</code>,
<code>count</code> and <code>status.count</code> Since the code is trivial I would recommend folks to copy it and modify to suit their own purposes. Here&rsquo;s the single file which constitutes the package:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Package statsdwrap exposes wrappers for http.Handler and http.HandlerFunc which send
</span><span style="color:#75715e">// metrics to statsd.
</span><span style="color:#75715e">// Usage:
</span><span style="color:#75715e">// r := chi.NewRouter()
</span><span style="color:#75715e">// statsdClient, _ := statsd.New(
</span><span style="color:#75715e">// statsd.Prefix(&#34;myapp&#34;),
</span><span style="color:#75715e">// statsd.Address(&#34;localhost:8125&#34;),
</span><span style="color:#75715e">// )
</span><span style="color:#75715e">// wrap := statsdwrap.NewChi(&#34;user_service&#34;, statsdClient)
</span><span style="color:#75715e">// handleHome := func(w http.ResponseWriter, r *http.Request) {
</span><span style="color:#75715e">// time.Sleep(time.Millisecond * 1000)
</span><span style="color:#75715e">// w.WriteHeader(http.StatusOK)
</span><span style="color:#75715e">// w.Write([]byte(&#34;OK&#34;))
</span><span style="color:#75715e">// }
</span><span style="color:#75715e">// r.Get(wrap.HandlerFunc(&#34;home&#34;, &#34;/&#34;, handleHome))
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">statsdwrap</span>

<span style="color:#f92672">import</span> (
<span style="color:#e6db74">&#34;bytes&#34;</span>
<span style="color:#e6db74">&#34;fmt&#34;</span>
<span style="color:#e6db74">&#34;net/http&#34;</span>
<span style="color:#e6db74">&#34;strings&#34;</span>

<span style="color:#e6db74">&#34;github.com/pressly/chi/middleware&#34;</span>
<span style="color:#e6db74">&#34;gopkg.in/alexcesaro/statsd.v2&#34;</span>
)

<span style="color:#75715e">// HandlerWrapper ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HandlerWrapper</span> <span style="color:#66d9ef">interface</span> {
  <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">routeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>)
  <span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#a6e22e">routeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handlerFunc</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>)
}

<span style="color:#75715e">// HTTPTxn a single http transaction record
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">HTTPTxn</span> <span style="color:#66d9ef">interface</span> {
  <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">status</span> <span style="color:#66d9ef">int</span>)
  <span style="color:#a6e22e">End</span>()
}

<span style="color:#75715e">// NewChi statsd wrapper client. Usage: NewChi(&#34;acme&#34;,statsdClient). The wrapper sends the metrics: response_time,
</span><span style="color:#75715e">// count and status.count. e.g. :
</span><span style="color:#75715e">// acme.home.response_time where home is the route name
</span><span style="color:#75715e">// acme.home.count
</span><span style="color:#75715e">// acme.home.status404.count
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewChi</span>(<span style="color:#a6e22e">prefix</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">statsdClient</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">HandlerWrapper</span> {
  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">cloneStatsdClient</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Client</span>
  <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">prefix</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;&#34;</span> {
    <span style="color:#a6e22e">cloneStatsdClient</span> = <span style="color:#a6e22e">statsdClient</span>.<span style="color:#a6e22e">Clone</span>()
  } <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">cloneStatsdClient</span> = <span style="color:#a6e22e">statsdClient</span>.<span style="color:#a6e22e">Clone</span>(<span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Prefix</span>(<span style="color:#a6e22e">prefix</span>))
  }
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">amp</span>;<span style="color:#a6e22e">defaultWrapper</span>{
  <span style="color:#a6e22e">client</span>: <span style="color:#a6e22e">cloneStatsdClient</span>,
  }

}

<span style="color:#75715e">// defaultWrapper statsd client
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">defaultWrapper</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Client</span>
}

<span style="color:#75715e">// startTransaction ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">defaultWrapper</span>) <span style="color:#a6e22e">startTransaction</span>(<span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">w</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">WrapResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) <span style="color:#a6e22e">HTTPTxn</span> {
  <span style="color:#a6e22e">entry</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">amp</span>;<span style="color:#a6e22e">httpTxn</span>{
    <span style="color:#a6e22e">name</span>: <span style="color:#a6e22e">name</span>,
    <span style="color:#a6e22e">timing</span>: <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">NewTiming</span>(),
    <span style="color:#a6e22e">responseTimeBucket</span>: <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;response_time&#34;</span>}, <span style="color:#e6db74">&#34;.&#34;</span>),
    <span style="color:#a6e22e">hitsBucket</span>: <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Join</span>([]<span style="color:#66d9ef">string</span>{<span style="color:#a6e22e">name</span>, <span style="color:#e6db74">&#34;count&#34;</span>}, <span style="color:#e6db74">&#34;.&#34;</span>),
    <span style="color:#a6e22e">defaultWrapper</span>: <span style="color:#a6e22e">d</span>,
    <span style="color:#a6e22e">ww</span>: <span style="color:#a6e22e">w</span>,
    <span style="color:#a6e22e">request</span>: <span style="color:#a6e22e">r</span>,
    <span style="color:#a6e22e">buf</span>: <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">amp</span>;<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>{},
  }

  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">entry</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">httpTxn</span> <span style="color:#66d9ef">struct</span> {
  <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">responseTimeBucket</span> <span style="color:#66d9ef">string</span>
  <span style="color:#a6e22e">hitsBucket</span> <span style="color:#66d9ef">string</span>

  <span style="color:#a6e22e">timing</span> <span style="color:#a6e22e">statsd</span>.<span style="color:#a6e22e">Timing</span>
  <span style="color:#f92672">*</span><span style="color:#a6e22e">defaultWrapper</span>
  <span style="color:#a6e22e">ww</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">WrapResponseWriter</span>
  <span style="color:#a6e22e">request</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>
  <span style="color:#a6e22e">buf</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">Buffer</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpTxn</span>) <span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">status</span> <span style="color:#66d9ef">int</span>) {
  <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">timing</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">responseTimeBucket</span>)
  <span style="color:#a6e22e">httpStatusBucket</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s.http%d&#34;</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">name</span>, <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ww</span>.<span style="color:#a6e22e">Status</span>())
  <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Increment</span>(<span style="color:#a6e22e">httpStatusBucket</span>)
  <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Increment</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">hitsBucket</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">httpTxn</span>) <span style="color:#a6e22e">End</span>() {
  <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">ww</span>.<span style="color:#a6e22e">Status</span>())
}

<span style="color:#75715e">// Handler ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">defaultWrapper</span>) <span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">routeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handler</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) {
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pattern</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
  <span style="color:#a6e22e">ww</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">middleware</span>.<span style="color:#a6e22e">NewWrapResponseWriter</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ProtoMajor</span>)
  <span style="color:#a6e22e">txn</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">startTransaction</span>(<span style="color:#a6e22e">routeName</span>, <span style="color:#a6e22e">ww</span>, <span style="color:#a6e22e">r</span>)
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">txn</span>.<span style="color:#a6e22e">End</span>()

    <span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">ww</span>, <span style="color:#a6e22e">r</span>)
  })
}

<span style="color:#75715e">// HandlerFunc ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">d</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">defaultWrapper</span>) <span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#a6e22e">routeName</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">pattern</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">handlerFunc</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>) (<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>) {
  <span style="color:#a6e22e">p</span>, <span style="color:#a6e22e">h</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">Handler</span>(<span style="color:#a6e22e">routeName</span>, <span style="color:#a6e22e">pattern</span>, <span style="color:#a6e22e">handlerFunc</span>)
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) { <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>) }
}
</code></pre></div><p>We can use the above pattern to write wrappers for different routers, metrics, logging etc. Use this with something like the <a href="https://github.com/bmhatfield/go-runtime-metrics">go-runtime-metrics</a> package and you have got a nice instrumentation going.</p>

  </div>

  <footer>
    <hr class="end-line">

    

    

    
    
  </footer>

  <div class="comments">



</div>

</article>


</body>
<div class="foot">
  
  

  
</div>



</html>
