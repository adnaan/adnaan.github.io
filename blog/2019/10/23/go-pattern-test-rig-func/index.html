<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.79.0" />

  <title> Go Pattern: Test Rig Func |  Time Traveling Gopher</title>
  <meta name="description" content="Time Traveling Gopher">
  <link rel="stylesheet" href="https://adnaan.badr.incss/simpleness.css">
  <link rel="canonical" href="https://adnaan.badr.in/blog/2019/10/23/go-pattern-test-rig-func/">
  <link rel="alternate" type="application/rss+xml" href="" title="Time Traveling Gopher">
  
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/css/all.min.css" rel="stylesheet">
</head>

<body>
  <header class="menus">
  
  <a href="https://adnaan.badr.in">Time Traveling Gopher</a>
  

  <nav >
    
  </nav>

  <nav class="fontawesome">
    
    
  </nav>
  
  
  <div class="hidden description">Time Traveling Gopher</div>
  
</header>

<article class="article">
  <header>
    <h1 style="text-align: center;" >Go Pattern: Test Rig Func</h1>

    <div class="post-meta">
    
      <time datetime="2019-10-23T16:33:01&#43;02:00">October 23, 2019</time> &nbsp; 
    

     &nbsp;

    
    
    

    

    
    </div>
  </header>

   

  <div class="text">
    <p>Often we need per-test setup and teardown. This is especially useful for third party integration testing, for e.g. testing against a database.</p>
<p>It looks fairly simple. Extending the example from a previous post: <a href="https://adnaan.badr.in/blog/2019/10/22/nifty-go-pkg-ory/dockertest/">Nifty Go Pkg: ory/dockertest</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">redisRig</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>, <span style="color:#a6e22e">fn</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>)) {

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#a6e22e">pool</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dockertest</span>.<span style="color:#a6e22e">NewPool</span>(<span style="color:#e6db74">&#34;&#34;</span>)
	<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)

	<span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Run</span>(<span style="color:#e6db74">&#34;redis&#34;</span>, <span style="color:#e6db74">&#34;5.0.6&#34;</span>, <span style="color:#66d9ef">nil</span>)
	<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rdb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Retry</span>(<span style="color:#66d9ef">func</span>() <span style="color:#66d9ef">error</span> {
		<span style="color:#a6e22e">rdb</span> = <span style="color:#a6e22e">newRedisClient</span>(<span style="color:#a6e22e">resource</span>.<span style="color:#a6e22e">GetPort</span>(<span style="color:#e6db74">&#34;6379/tcp&#34;</span>))
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Ping</span>().<span style="color:#a6e22e">Err</span>()
	})
	<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)

	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">rdb</span>.<span style="color:#a6e22e">Close</span>()

	<span style="color:#75715e">// run even if the test fails
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">// remove resources
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Purge</span>(<span style="color:#a6e22e">resource</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
	}()
	<span style="color:#75715e">// call test function
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">rdb</span>)
}
</code></pre></div><p>Use it in a test.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestService</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
    <span style="color:#a6e22e">redisRig</span>(<span style="color:#a6e22e">t</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">rdb</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">redis</span>.<span style="color:#a6e22e">Client</span>) {
            <span style="color:#a6e22e">svc</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">newService</span>(<span style="color:#a6e22e">rdb</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;new service err %v&#34;</span>,<span style="color:#a6e22e">err</span>)
                <span style="color:#66d9ef">return</span>
            }
        })
}
</code></pre></div><p>The catch here is to use <a href="https://golang.org/pkg/testing/#T.Errorf">T.Errorf</a> or similar, so that we don&rsquo;t fatally exit the test using <code>t.Fatal</code>. If we exit fatally, cleanup code won&rsquo;t run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">	<span style="color:#75715e">// run even if the test fails
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#75715e">// remove resources
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">pool</span>.<span style="color:#a6e22e">Purge</span>(<span style="color:#a6e22e">resource</span>)
		<span style="color:#a6e22e">assert</span>.<span style="color:#a6e22e">Nil</span>(<span style="color:#a6e22e">t</span>, <span style="color:#a6e22e">err</span>)
	}()
</code></pre></div><p><code>T.Errorf</code> internally calls <code>T.Fail</code> which fails the test but execution continues.</p>
<p>This pattern can be used for: setup/teardown databases, constructing clients to third party services etc.</p>

  </div>

  <footer>
    <hr class="end-line">

    

    

    
    
  </footer>

  <div class="comments">



</div>

</article>


</body>
<div class="foot">
  
  

  
</div>



</html>
