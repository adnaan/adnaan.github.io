<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta name="generator" content="Hugo 0.58.2" />

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="Adnaan Badr">
  <meta property="og:url" content="https://adnaan.badr.in/blog/2019/10/23/go-pattern-test-rig-func/">

  <title>Go Pattern: Test Rig Func - Time Traveling Gopher</title>
  <meta property="og:title" content="Go Pattern: Test Rig Func - Time Traveling Gopher">
  <meta property="og:type" content="article">
  <meta name="description" content="">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Arvo:400,700">
  <link rel="stylesheet" href="/css/highlight.css">
  <link rel="stylesheet" href="/css/journal.css">
  <link href="/index.xml" rel="alternate" type="application/rss+xml" title="Time Traveling Gopher">

</head>

<body>
  <div class="container">

    <nav class="site-nav">
      <a href="https://adnaan.badr.in">Index</a>
    </nav>


  <article class="post">
    <header class="post-header">
      <h1 class="post-title">Go Pattern: Test Rig Func</h1>
      <time class="post-date" datetime="2019-10-23 16:33:01 CEST">23 Oct 2019</time>
    </header>

    <p>Often we need per-test setup and teardown. This is especially useful for third party integration testing, for e.g. testing against a database.</p>

<p>It looks fairly simple. Extending the example from a previous post: <a href="https://adnaan.badr.in/blog/2019/10/22/nifty-go-pkg-ory/dockertest/">Nifty Go Pkg: ory/dockertest</a></p>

<pre><code class="language-go">func redisRig(t *testing.T, fn func(rdb *redis.Client)) {

	var err error
	pool, err := dockertest.NewPool(&quot;&quot;)
	assert.Nil(t, err)

	resource, err := pool.Run(&quot;redis&quot;, &quot;5.0.6&quot;, nil)
	assert.Nil(t, err)

	var rdb *redis.Client
	err = pool.Retry(func() error {
		rdb = newRedisClient(resource.GetPort(&quot;6379/tcp&quot;))
		return rdb.Ping().Err()
	})
	assert.Nil(t, err)

	defer rdb.Close()

	// run even if the test fails
	defer func() {
		// remove resources
		err = pool.Purge(resource)
		assert.Nil(t, err)
	}()
	// call test function
	fn(rdb)
}
</code></pre>

<p>Use it in a test.</p>

<pre><code class="language-go">func TestService(t *testing.T) {
    redisRig(t, func(rdb *redis.Client) {
            svc, err := newService(rdb)
            if err != nil {
                t.Errorf(&quot;new service err %v&quot;,err)
                return
            }
        })
}
</code></pre>

<p>The catch here is to use <a href="https://golang.org/pkg/testing/#T.Errorf">T.Errorf</a> or similar, so that we don&rsquo;t fatally exit the test using <code>t.Fatal</code>. If we exit fatally, cleanup code won&rsquo;t run:</p>

<pre><code class="language-go">	// run even if the test fails
	defer func() {
		// remove resources
		err = pool.Purge(resource)
		assert.Nil(t, err)
	}()
</code></pre>

<p><code>T.Errorf</code> internally calls <code>T.Fail</code> which fails the test but execution continues.</p>

<p>This pattern can be used for: setup/teardown databases, constructing clients to third party services etc.</p>


  </article>

<footer class="site-footer">
  <span itemscope itemtype="http://schema.org/Person">
    <link itemprop="url" href="https://adnaan.badr.in">
    <span itemprop="name">Adnaan Badr</span>

    <br>

    <a itemprop="sameAs" href="https://github.com/adnaan" title="GitHub">Github</a>

    <a itemprop="sameAs" href="https://twitter.com/adnaanx" title="Twitter">Twitter</a>


    <a itemprop="sameAs" href="https://www.linkedin.com/in/adnaanx"
      title="LinkedIn">LinkedIn</a>


    
  </span>

  
</footer>
</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

</body>

</html>
